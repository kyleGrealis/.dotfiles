---
title: ""
date: last-modified
---


```{r}
#| label: setup
source('R/_libraries.R')
source('R/data_dictionary.R')
load('data/the_data.rda')

reduced <- the_data |> 
  filter(between(year, 1999, 2010))
```

```{r}
#| label: set-up definitions
# Definition 1: Diagnosis of diabetes before age 30 years, now taking insulin, started 
# taking insulin within one year of diagnosis.
defined <- reduced |> 
  mutate(
    # Definition 1: Diagnosis of diabetes before age 30 years, now taking insulin, started 
    # taking insulin within one year of diagnosis.
    definition_one = case_when(
      (
        # Diagnosis of diabetes before age 30 (var: did040)
        did040 < 30 &
          # now taking insulin (var: diq050)
          diq050 == 'Yes' &
          # started taking insulin within one year of diagnosis 
          # (var: did060 -- how long taking insulin)
          insulin_within_1yr == TRUE
      ) ~ 'Type 1',
      .default = 'not Type 1'
    ),

    # Definition 2: Diagnosis of diabetes before age 40 years, now taking insulin, 
    # started taking insulin within one year of diagnosis.
    definition_two = case_when(
      (
        # Diagnosis of diabetes before age 40 (var: did040)
        did040 < 40 &
          # now taking insulin (var: diq050)
          diq050 == 'Yes' &
          # started taking insulin within one year of diagnosis 
          # (var: did060 -- how long taking insulin)
          insulin_within_1yr == TRUE
      ) ~ 'Type 1',
      .default = 'not Type 1'
    ),
  )
```


```{r}
#| label: view results
defined |> 
  tabyl(definition_one) |> 
  adorn_pct_formatting(digits = 2)
defined |> 
  tabyl(definition_two) |> 
  adorn_pct_formatting(digits = 2)
```

The original study identified "59,130 NHANES participants, 123 individuals met the 
definition 1 criteria and 160 the definition 2 criteria." However, our study analyzed 
89,732 participants where 140 met the definition 1 criteria and 206 met the definition 2 
criteria. This represents increases of 13.8% and 28.8% for each definition respectively.

## Create a survey design object

Need to create a survey design object to obtain and compare the prevalence weights. Since
this study incorporates multiple survey cycles & sample weights. Review 
[this reference](https://wwwn.cdc.gov/nchs/nhanes/tutorials/weighting.aspx) to select the
proper survey weight based on which variables are to be used in the analysis.

There are 3 types of survey weights:  
- interview weight (`wtint2yr`)  
- MEC exam weight (`wtmec2yr`)  
- fasting subsample weight (`wtsaf2yr`)

Our variables that require using the MEC weights:
- BMX variables (body scan)
- DXX variables (dexa scan)
- lbxgh (glycohemoglobin)
- lbxtc (cholesterol)
- lbdhdd (hdl cholesterol)
- BPX (blood pressure measures)

Our variables that require using the fasting weights:
- lbxtr
- lbdldl
- lbxglu (fasting glucose)

> For any combination of survey cycles from 2001-2002 and beyond that does not include 1999-2000 data, the multiyear sample weight constructed using the formulas in the above table is a linear scaling of the two-year weight, i.e. the weight is multiplied by a constant equal to (1 / number of survey cycles.) 

There are 11 cycles in our dataset:
```
>> unique(the_data$year)
[1] 1999 2001 2003 2005 2007 2009 2011 2013 2015 2017 2021
```

EXAMPLE: To combine the first 2 cycles (1999 & 2001) with the following 2 cycles:
```{r}
#| eval: false
cycles <- c(1999, 2001, 2003, 2005)
the_data |> 
  filter(year %in% cycles) |>
  mutate(
    wt8yrs = case_when(
      year %in% c(1999, 2001) ~ wtmec4yr * 2/4,  # MUST use the 4-yr weight here
      year %in% c(2003, 2005) ~ wtmec2yr * 1/4,  # no 4-yr weight, so must use 2-yr weight
      .default = 9999
    )
  )
```
Notice above that the denominator is 4 since there are 4 total cycles. The denominator is
ALWAYS the number of cycles used -AND- if either 1999 or 2001 is included in the analysis,
then their 4-yr weight variable must be used. All others will use the 2-yr weight. Also
note that the numerator for the 1999 & 2001 cycles is 2 since it uses the 4-yr weight variable.

EXAMPLE 2: excluding 1999 & 2001, using 6 cycles
```{r}
#| eval: false
cycles <- c(2003, 2005, 2007, 2009, 2011, 2013)
the_data |> 
  filter(year %in% cycles) |> 
  mutate(
    mec_weight = wtmec2yr / length(cycles)
  )
```

EXAMPLE 3: using all of our cycles
```{r}
#| eval: false
cycles <- unique(the_data$years)
the_data |> 
  mutate(
    mec_weight = if_else(
      year %in% c(1999, 2001), 
      wtmec4yr * 2/length(cycles),  # MUST use the 4-yr weight here
      wtmec2yr * 1/length(cycles)   # no 4-yr weight, so must use 2-yr weight
    )
  )
```

NOTE: The above examples are using the MEC WEIGHTS since we are assuming that at least
one variable is from the medical exam portion of NHANES data. We are also temporarily
ignoring that our data also includes fasting variables listed above. Those fasting 
variables MUST be excluded before properly calculating the weight, but these examples 
are only to show proof of concept!