---
title: ''
date: last-modified
---


```{r}
#| label: setup
source('R/_libraries.R')
source('R/data_dictionary.R')
load('data/the_data.rda')

reduced <- the_data |>
  filter(between(year, 1999, 2010))
```

```{r}
#| label: set-up definitions
# Definition 1: Diagnosis of diabetes before age 30 years, taking insulin now, started
# taking insulin within one year of diagnosis.
defined <- reduced |>
  mutate(
    # Definition 1: Diagnosis of diabetes before age 30 years, taking insulin now, started
    # taking insulin within one year of diagnosis.
    definition_one = case_when(
      (
        # Diagnosis of diabetes before age 30 (var: did040)
        # did040 < 30 &
        age_told_diabetes < 30 &
          # taking insulin now (var: diq050)
          diq050 == 'Yes' &
          # started taking insulin within one year of diagnosis
          # (var: did060 -- how long taking insulin)
          insulin_within_1yr == TRUE
      ) ~
        'Type 1',
      .default = 'not Type 1'
    ),

    # Definition 2: Diagnosis of diabetes before age 40 years, taking insulin now,
    # started taking insulin within one year of diagnosis.
    definition_two = case_when(
      (
        # Diagnosis of diabetes before age 40 (var: did040)
        # did040 < 40 &
        age_told_diabetes < 40 &
          # taking insulin now (var: diq050)
          diq050 == 'Yes' &
          # started taking insulin within one year of diagnosis
          # (var: did060 -- how long taking insulin)
          insulin_within_1yr == TRUE
      ) ~
        'Type 1',
      .default = 'not Type 1'
    ),
  )
```


```{r}
#| label: view results
# Updated on 10.9.2025 -- after reprocessing variables & modifying variable names. See
# the newly-revised data_pull.qmd file (specifically section on DIQ_* diabetes data).
defined |>
  tabyl(definition_one) |>
  adorn_pct_formatting(digits = 2)
#  definition_one     n percent
#          Type 1   189   0.21%
#      not Type 1 89543  99.79%
defined |>
  tabyl(definition_two) |>
  adorn_pct_formatting(digits = 2)
#  definition_two     n percent
#          Type 1   270   0.30%
#      not Type 1 89462  99.70%
```

The original study identified '59,130 NHANES participants, 123 individuals met the 
definition 1 criteria and 160 the definition 2 criteria.' However, our study analyzed 
89,732 participants where 189 met the definition 1 criteria and 270 met the definition 2 
criteria. This represents increases of 53.7% and 68.8% for each definition respectively,
and an increase in the analyzed population of 51.8%.

These differences may reflect additional NHANES survey cycles, updated data releases, 
or differences in inclusion/exclusion criteria between studies. Further investigation 
of the original study's methodology (i.e., data preprocessing) would be needed to 
determine the exact cause.


## Create a survey design object

```{r}
#| label: survey design creation
cycles <- unique(defined$year)

survey_dat <- defined |> 
  mutate(
    int_weight = case_when(
      year %in% c(1999, 2001) ~ wtint4yr * 2/length(cycles),  # MUST use 4-yr weight here
      .default = wtint2yr * 1/length(cycles)   # no 4-yr weight for these cycles
    )
  )

design <- srvyr::as_survey_design(
  ids = sdmvpsu,           # Primary sampling units
  strata = sdmvstra,       # Strata  
  weights = int_weight,    # Interview exam weights (use questionairre, non-exam)
  nest = TRUE,
  .data = survey_dat
)

design
```

## Perform statistical summaries

```{r}
#| label: definition one prevalence
design |> 
  summarize(population = survey_total())

design |> 
  group_by(definition_one) |> 
  survey_tally()

design |> 
  group_by(definition_two) |> 
  survey_tally()

# Initial prevalence calculations:
# >> 1220208/440103260
# [1] 0.002773
# >> 1692839/440103260
# [1] 0.003846

# These do not differ too far from the original values presented in the Table 2.5. This
# may be because the analyzed population increased as data was updated as compared to the
# original 2018 table presentation. 
```


```{r}
#| label: survey table
#| eval: false
# UNSURE ABOUT the results presented in this table
design |> 
  tbl_svysummary(
    by = definition_one,
    percent = 'row',
    include = riagendr,
    digits = list(all_categorical() ~ c(0, 4))  # counts to 0 decimals, % to 4
  ) |> 
  extras(overall = FALSE, pval = FALSE)
```


```{r}
#| label: definition vs overall
glue_content <- '{round(prop * 100, 2)} ({round(prop_low * 100, 2)} - {round(prop_upp * 100, 2)})'

def1_overall <- design |> 
  group_by(definition_one) |> 
  summarize(
    prop = survey_mean(vartype = 'ci'),
    total = survey_total()
  ) |> 
  slice(1) |> 
  mutate(
    group = 'Overall',
    result = glue::glue(glue_content)
  ) |> 
  select(group, `Def. 1: Pct (95% CI)` = result)

def2_overall <- design |> 
  group_by(definition_two) |> 
  summarize(
    prop = survey_mean(vartype = 'ci'),
    total = survey_total()
  ) |> 
  mutate(
    group = 'Overall',
    result = glue::glue(glue_content)
  ) |> 
  select(group, `Def. 2: Pct (95% CI)` = result) |> 
  slice(1)
```

```{r}
#| label: definition vs age group
def1_age <- design |> 
  group_by(age_group, definition_one) |> 
  summarize(
    prop = survey_prop(vartype = 'ci'),
    total = survey_total()
  ) |> 
  ungroup() |> 
  mutate(
    group = glue::glue('{age_group}'),
    result = glue::glue(glue_content)
  ) |> 
  select(definition_one, group, `Def. 1: Pct (95% CI)` = result) |> 
  arrange(definition_one) |> 
  slice(1:4) |> 
  select(-definition_one)

def2_age <- design |> 
  group_by(age_group, definition_two) |> 
  summarize(
    prop = survey_mean(vartype = 'ci'),
    total = survey_total()
  ) |> 
  ungroup() |> 
  mutate(
    group = glue::glue('{age_group}'),
    result = glue::glue(glue_content)
  ) |> 
  select(definition_two, group, `Def. 2: Pct (95% CI)` = result) |> 
  arrange(definition_two) |> 
  slice(1:4) |> 
  select(-definition_two)
```

```{r}
#| label: definition vs sex
def1_sex <- design |> 
  group_by(riagendr, definition_one) |> 
  summarize(
    prop = survey_prop(vartype = 'ci'),
    total = survey_total()
  ) |> 
  ungroup() |> 
  mutate(
    group = glue::glue('{riagendr}'),
    result = glue::glue(glue_content)
  ) |> 
  select(definition_one, group, `Def. 1: Pct (95% CI)` = result) |> 
  arrange(definition_one) |> 
  slice(1:2) |> 
  select(-definition_one)

def2_sex <- design |> 
  group_by(riagendr, definition_two) |> 
  summarize(
    prop = survey_mean(vartype = 'ci'),
    total = survey_total()
  ) |> 
  ungroup() |> 
  mutate(
    group = glue::glue('{riagendr}'),
    result = glue::glue(glue_content)
  ) |> 
  select(definition_two, group, `Def. 2: Pct (95% CI)` = result) |> 
  arrange(definition_two) |> 
  slice(1:2) |> 
  select(-definition_two)
```

```{r}
#| label: definition vs ethnicity
def1_ethn <- design |> 
  group_by(ethn_collapsed, definition_one) |> 
  summarize(
    prop = survey_prop(vartype = 'ci'),
    total = survey_total()
  ) |> 
  ungroup() |> 
  mutate(
    group = glue::glue('{ethn_collapsed}'),
    result = glue::glue(glue_content)
  ) |> 
  select(definition_one, group, `Def. 1: Pct (95% CI)` = result) |> 
  arrange(definition_one, desc(group)) |> 
  filter(group != 'NA') |> 
  slice(1:3) |> 
  select(-definition_one)

def2_ethn <- design |> 
  group_by(ethn_collapsed, definition_two) |> 
  summarize(
    prop = survey_mean(vartype = 'ci'),
    total = survey_total()
  ) |> 
  ungroup() |> 
  mutate(
    group = glue::glue('{ethn_collapsed}'),
    result = glue::glue(glue_content)
  ) |> 
  select(definition_two, group, `Def. 2: Pct (95% CI)` = result) |> 
  arrange(definition_two, desc(group)) |> 
  filter(group != 'NA') |> 
  slice(1:3) |> 
  select(-definition_two)
```


```{r}
#| label: combine tables
def1 <- bind_rows(def1_overall, def1_age, def1_sex, def1_ethn)
def2 <- bind_rows(def2_overall, def2_age, def2_sex, def2_ethn)
left_join(def1, def2, by = 'group') |> 
  gt() |> 
  # Add spanning header for the two definition columns
  tab_spanner(
    label = 'PERCENT (95% CI)',
    columns = c(2, 3)  # Adjust column numbers if needed
  ) |> 
  # Add grouping rows
  tab_row_group(label = 'Total', rows = 1) |> 
  tab_row_group(label = 'Current age (years)', rows = 2:5) |> 
  tab_row_group(label = 'Sex', rows = 6:7) |> 
  tab_row_group(label = 'Race/ethnicity', rows = 8:10) |>
  row_group_order(groups = c('Total', 'Current age (years)', 'Sex', 'Race/ethnicity')) |> 
  sumExtras::theme_gt_compact()
```