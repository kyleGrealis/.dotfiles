---
title: "How to use weighting with NHANES data"
date: last-modified
code-fold: false
---


# Use weights to create a survey design object

Since this study incorporates multiple survey cycles & sample weights. Review 
[this NHANES reference](https://wwwn.cdc.gov/nchs/nhanes/tutorials/weighting.aspx) to 
select the proper survey weight based on which variables are to be used in the analysis.

There are 3 types of survey weights:  
- interview weight (`wtint2yr`)  
- MEC exam weight (`wtmec2yr`)  
- fasting subsample weight (`wtsaf2yr`)

Our variables that require using the MEC weights:
- BMX variables (body scan)
- DXX variables (dexa scan)
- lbxgh (glycohemoglobin)
- lbxtc (cholesterol)
- lbdhdd (hdl cholesterol)
- BPX (blood pressure measures)

Our variables that require using the fasting weights:
- lbxtr
- lbdldl
- lbxglu (fasting glucose)

> For any combination of survey cycles from 2001-2002 and beyond that does not include 1999-2000 data, the multiyear sample weight constructed using the formulas in the above table is a linear scaling of the two-year weight, i.e. the weight is multiplied by a constant equal to (1 / number of survey cycles.) 

There are 11 cycles in our dataset:
```
>> unique(the_data$year)
[1] 1999 2001 2003 2005 2007 2009 2011 2013 2015 2017 2021
```

EXAMPLE: To combine the first 2 cycles (1999 & 2001) with the following 2 cycles:
```{r}
#| eval: false
cycles <- c(1999, 2001, 2003, 2005)
the_data |> 
  filter(year %in% cycles) |>
  mutate(
    wt8yrs = case_when(
      year %in% c(1999, 2001) ~ wtmec4yr * 2/4,  # MUST use the 4-yr weight here
      year %in% c(2003, 2005) ~ wtmec2yr * 1/4,  # no 4-yr weight, so must use 2-yr weight
      .default = 9999
    )
  )
```
Notice above that the denominator is 4 since there are 4 total cycles. The denominator is
ALWAYS the number of cycles used -AND- if either 1999 or 2001 is included in the analysis,
then their 4-yr weight variable must be used. All others will use the 2-yr weight. Also
note that the numerator for the 1999 & 2001 cycles is 2 since it uses the 4-yr weight variable.

EXAMPLE 2: excluding 1999 & 2001, using 6 cycles
```{r}
#| eval: false
cycles <- c(2003, 2005, 2007, 2009, 2011, 2013)
the_data |> 
  filter(year %in% cycles) |> 
  mutate(
    mec_weight = wtmec2yr / length(cycles)
  )
```

EXAMPLE 3: using all of our cycles
```{r}
#| eval: false
cycles <- unique(the_data$years)
the_data |> 
  mutate(
    mec_weight = if_else(
      year %in% c(1999, 2001), 
      wtmec4yr * 2/length(cycles),  # MUST use the 4-yr weight here
      wtmec2yr * 1/length(cycles)   # no 4-yr weight, so must use 2-yr weight
    )
  )
```

NOTE: The above examples are using the MEC WEIGHTS since we are assuming that at least
one variable is from the medical exam portion of NHANES data. We are also temporarily
ignoring that our data also includes fasting variables listed above. Those fasting 
variables MUST be excluded before properly calculating the weight, but these examples 
are only to show proof of concept!
