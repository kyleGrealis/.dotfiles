---
title: "Five-Step Classification Algorithm for Type 1 Diabetes with Adiposity Measures (NHANES 2011-2022)"
date: last-modified
---

{{< brand logo large >}}


## Purpose & Methods

Apply a five-step diabetes classification to our working NHANES cohort (2011-2022) 
[@mosslemi_2020]. The [methods](https://pmc.ncbi.nlm.nih.gov/articles/PMC7041875/) 
involve evaluating the NHANES responses as they relate to five questions:  
1. Is there valid diabetes-related information?  
2. Is the participant currently taking medication for diabetes?  
3. Is the participant currently taking insulin?  
4. Is the participant currently taking _only_ insulin?  
5. Has the participant started taking insulin within a year of diagnosis?  

<!-- ![Mosslemi et al. five-step diagnostic process](misc/img/five-step.jpg) -->

![Figure 1: Results of Mosslemi et al. five-step diagnostic classification](misc/img/main_consort.png)


## Analysis & Application

```{r}
#| label: setup
#| echo: false
source("R/_libraries.R")
source("R/data_dictionary.R")

source('R/custom_functions.R')
source('R/custom_table_functions.R')

load('data/the_data.rda')
```

```{r}
#| label: step-0a
# Participants with diagnosed diabetes

# Self-reported diagnosis options are: Yes, No, Borderline, Don't know, <NA>
tabyl(the_data, diq010) |> 
  adorn_pct_formatting() |> 
#     diq010     n percent valid_percent
#         Yes  4275    8.4%          8.7%
#          No 44120   86.4%         89.4%
#  Borderline   925    1.8%          1.9%
#  Don't know    22    0.0%          0.0%
#     Refused     2    0.0%          0.0%
#        <NA>  1745    3.4%             -
  gt() |> 
  cols_label(
    diq010 = 'Doctor told you have diabetes',
    n = 'Count', percent = 'Percent',
    valid_percent = 'Valid percent'
  ) |> 
  tab_header(
    title = md('**Step 0a**: Valid prior diagnosis of diabetes'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()
```

```{r}
#| label: step-0b
# For those reporting a value for age at diabetes diagnosis, some didn't know what age
#   or refused to answer. Therefore, `diab_duration` (time since diagnosis) is 
#   incalculable and should be excluded.
the_data |> 
  mutate(valid_resp = if_else(!is.na(did040), 'Yes', 'No')) |> 
  tabyl(valid_resp) |> 
  adorn_pct_formatting() |> 
# valid_resp     n percent
#          No 46818   91.6%   * should be excluded
#         Yes  4271    8.4%
  gt() |> 
  cols_label(
    valid_resp = 'Has valid "Age when first told you have diabetes"',
    n = 'Count', percent = 'Percent'
  ) |> 
  tab_header(
    title = md('**Step 0b**: Valid prior diagnosis of diabetes<br>Those with known age of diabetes diagnosis'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()
```

```{r}
#| label: step-0c
# Which participants have a self-reported "Yes" diabetes prior diagnosis AND have a
#   calculated value for time since diagnosis. We will proceed with filtering to only
#   include these participants.
the_data |> 
  mutate(has_duration_val = if_else(!is.na(diab_duration), 'Valid', 'Not valid')) |> 
  tabyl(diq010, has_duration_val) |> 
#      diq010 Not valid Valid
#         Yes         4  4271
#          No     44120     0
#  Borderline       925     0
#  Don't know        22     0
#     Refused         2     0
#        <NA>      1745     0
  gt() |> 
  cols_label(diq010 = 'Doctor told you have diabetes') |> 
  tab_header(
    title = md('**Step 0c**: Valid prior diagnosis of diabetes<br>Those with valid duration of disease information'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()

step_0 <- the_data |> 
  filter(!is.na(diab_duration))

# nrow(the_data)  # 51089 original participants from 2011-2022
# nrow(step_0)    # 4271 with self-reported previous diabetes diagnosis & duration info
```

While some participants met multiple exclusion criteria, after preprocessing, there are 
`r nrow(step_0)` participants with a valid self-reported  previous diabetes diagnosis and 
valid disease duration information. We will continue using this cohort (*N*=
`r nrow(step_0)`).



### Step 1: Has valid diabetes-related information

"Participants who did not have a reply to treatment questions (DIQ.050, DIQ.060, 
DIQ.070) – either ‘don’t know’ or ‘refused’ response – and those whose insulin 
treatment period (DIQ.060) appeared longer than their time since diagnosis were 
excluded."

```{r}
#| label: step-1
# Has valid diabetes-related information

# "Participants who did not have a reply to treatment questions (DIQ.050, DIQ.060, 
#   DIQ.070) – either ‘don’t know’ or ‘refused’ response – and those whose insulin 
#   treatment period (DIQ.060) appeared longer than their time since diagnosis were 
#   excluded."
step_1 <- step_0 |> 
  mutate(
    # diq060: Numeric duration for years using insulin
    yrs_using_insulin = did060,
    # Flag those where their insulin treatment period exceeds their diab_duration
    flag_duration = case_when(
      yrs_using_insulin > diab_duration ~ 'Remove', 
      is.na(yrs_using_insulin) ~ 'Keep',  # these are ok to keep
      .default = 'Keep'
    )
  )

# Inspect those with the flag indicating they state to use insulin longer than diabetes
#   duration.
tabyl(step_1, flag_duration) |> 
  adorn_pct_formatting() |> 
#  flag_duration    n percent
#           Keep 4063   95.1%
#         Remove  208    4.9%
  gt() |> 
  cols_label(
    flag_duration = 'Reported insulin use longer than duration of diabetes',
    n = 'Count', percent = 'Percent'
  ) |> 
  tab_header(
    title = md('**Step 1a**: Has valid diabetes-related information<br>Those with valid duration of disease versus duration of insulin use information'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()

# Inspect responses for diq050 & diq070:
tabyl(step_1, diq050) |> 
  adorn_pct_formatting() |> 
#      diq050    n percent
#         Yes 1275   29.9%
#          No 2994   70.1%
#  Don't know    2    0.0% * remove per manuscript's methods
  gt() |> 
  cols_label(
    diq050 = 'Taking insulin now',
    n = 'Count', percent = 'Percent'
  ) |> 
  tab_header(
    title = md('**Step 1b**: Has valid diabetes-related information<br>Those with valid known medication (insulin) use information'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()

tabyl(step_1, diq070) |> 
  adorn_pct_formatting() |> 
#      diq070    n percent
#         Yes 2995   70.1%
#          No 1267   29.7%
#  Don't know    8    0.2% * remove per manuscript's methods
#     Refused    1    0.0% * remove per manuscript's methods
  gt() |> 
  cols_label(
    diq070 = 'Take diabetic pills to lower blood sugar',
    n = 'Count', percent = 'Percent'
  ) |> 
  tab_header(
    title = md('**Step 1c**: Has valid diabetes-related information<br>Those with valid known medication (diabetic pills) use information'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()

# Remove participants not meeting inclusion criteria.
step_1d <- step_1 |> 
  filter(
    # diq050: Taking insulin now
    diq050 %in% c('Yes', 'No'),
    # flag_duration: report using insulin longer than diabetes duration
    flag_duration != 'Remove',
    # diq070: Take diabetic pills to lower blood sugar
    diq070 %in% c('Yes', 'No')
  )

# nrow(step_1)    # 4271
# nrow(step_1d)   # 4052 -- This is good since there were 219 (208+2+9) identified in the 
                  # janitor tabyls above! Good to move forward.
```

There were `r sum(step_1$flag_duration == 'Remove')` participants removed for indicating insulin
use longer than their reported duration of diabetes. There was/were also
`r sum(step_1$diq050 == "Don't know")` participant(s) removed for reporting "Don't know" for
DIQ.050 ("Taking insulin now") and `r sum(step_1$diq070 == "Don't know")` participants
removed for reporting "Don't know" for DIQ.070 ("Take diabetic pills to lower blood 
sugar").

<mark>The cohort was thereby reduced from `r nrow(step_1)` to `r nrow(step_1d)` participants who
fully met the inclusion criteria.</mark> This cohort will now be assessed for diabetes
classification.



### Step 2: Currently takes medication for diabetes

"Participants who replied ‘no’ to DIQ.050 and ‘no’ to DIQ.070, meaning that they were 
neither currently taking insulin nor an oral hypoglycemic agent, were assigned as T2D.
The rest were moved forward."

```{r}
#| label: step-2
# Currently takes medication for diabetes

# "Participants who replied ‘no’ to DIQ.050 and ‘no’ to DIQ.070, meaning that they were 
#   neither currently taking insulin nor an oral hypoglycemic agent, were assigned as T2D.
#   The rest were moved forward."
step_2 <- step_1d |> 
  # Remove unnecessary variable(s)
  select(-flag_duration) |> 
  mutate(
    # Create initial diabetes categorization variable. This will be iteratively added to
    # throughout the recreating the manuscript steps.
    step_2_var = case_when(
      (
        # "neither currently taking insulin nor an oral hypoglycemic agent..."
        diq050 == 'No' & 
        diq070 == 'No'
      ) ~ 'T2D',
      .default = 'continue'
    )
  )

st2_dx <- sum(step_2$step_2_var == 'T2D')
st2_dx_pct <- round((st2_dx / nrow(step_2)) * 100, 2)

tabyl(step_2, step_2_var) |> 
  adorn_pct_formatting() |> 
#  step_2_var    n percent
#         T2D  703   17.3%  * identified in this step
#    continue 3349   82.7%
  gt() |> 
  cols_label(
    step_2_var = 'Diagnosed in Step 2',
    n = 'Count', percent = 'Percent'
  ) |> 
  tab_header(
    title = md('**Step 2**: Currently takes medication for diabetes'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()
```

<mark>`r st2_dx` (`r st2_dx_pct`%) participants were identified as having Type II 
diabetes during Step 2.</mark> The remaining `r sum(step_2$step_2_var != 'T2D')` will continue
through the classification algorithm.



### Step 3: Currently takes insulin

"Participants who replied ‘no’ to DIQ.050 and therefore were not currently taking 
insulin were assigned as T2D. The rest were moved forward."

```{r}
#| label: step-3
# Currently takes insulin

# "Participants who replied ‘no’ to DIQ.050 and therefore were not currently taking 
#   insulin were assigned as T2D. The rest were moved forward."
step_3 <- step_2 |> 
  mutate(
    step_3_var = case_when(
      step_2_var == 'T2D' ~ 'already classified',
      diq050 == 'No' ~ 'T2D',
      .default = 'continue'
    )
  )

st3_dx <- sum(step_3$step_3_var == 'T2D')
st3_dx_pct <- round((st3_dx / nrow(step_3)) * 100, 2)

tabyl(step_3, step_3_var) |> 
  adorn_pct_formatting() |> 
#          step_3_var    n percent
#                 T2D 2285   56.4% * identified in this step
#  already classified  703   17.3%
#            continue 1064   26.3%
  gt() |> 
  cols_label(
    step_3_var = 'Diagnosed in Step 3',
    n = 'Count', percent = 'Percent'
  ) |> 
  tab_header(
    title = md('**Step 3**: Currently takes insulin'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()
```

<mark>`r st3_dx` (`r st3_dx_pct`%) participants were newly identified as having Type II
diabetes during Step 3.</mark>
`r sum(step_3$step_3_var == 'already classified')` participants have been previously
classified in Step 2.
The remaining `r sum(step_3$step_3_var == 'continue')` participants that were not 
previously classified will continue through the classification algorithm.



### Step 4: Currently takes only insulin

"Participants who replied ‘yes’ to DIQ.050 and ‘yes’ to DIQ.070, meaning they were 
taking both insulin and an oral hypoglycemic agent, were assigned as T2D. The rest
were moved forward."

```{r}
#| label: step-4
# Currently takes only insulin

# "Participants who replied ‘yes’ to DIQ.050 and ‘yes’ to DIQ.070, meaning they were 
#   taking both insulin and an oral hypoglycemic agent, were assigned as T2D. The rest
#   were moved forward."
step_4 <- step_3 |> 
  mutate(
    step_4_var = case_when(
      (
        step_2_var == 'T2D' |
        step_3_var == 'T2D'
      ) ~ 'already classified',
      (
        diq050 == 'Yes' &
        diq070 == 'Yes'
      ) ~ 'T2D',
      .default = 'continue'
    )
  )

st4_dx <- sum(step_4$step_4_var == 'T2D')
st4_dx_pct <- round((st4_dx / nrow(step_4)) * 100, 2)

tabyl(step_4, step_4_var) |> 
  adorn_pct_formatting() |> 
#          step_4_var    n percent
#                 T2D  605   14.9%  * identified in this step
#  already classified 2988   73.7%
#            continue  459   11.3%
  gt() |> 
  cols_label(
    step_4_var = 'Diagnosed in Step 4',
    n = 'Count', percent = 'Percent'
  ) |> 
  tab_header(
    title = md('**Step 4**: Currently takes **only** insulin'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()
```

<mark>`r st4_dx` (`r st4_dx_pct`%) participants were newly identified as having Type II
diabetes during Step 4.</mark> 
`r sum(step_4$step_4_var == 'already classified')` participants have been previously
classified in Step 2 or Step 3.
The remaining `r sum(step_4$step_4_var == 'continue')` participants that were not 
previously classified will continue through the classification algorithm.



### Step 5: Starting taking insulin within a year after diagnosis

"Participants whose time since diagnosis minus their answer to DIQ.060, insulin 
treatment period, was one year or less, meaning they started taking insulin within 
a year after diagnosis, were assigned as T1D. The rest were labeled as 
‘possible-T2D’."

We used our created variables `diab_duration` (diabetes duration) and `yrs_using_insulin`
(year of insulin use) in place of DIQ.060.

```{r}
#| label: step-5
# Starting taking insulin within a year after diagnosis

# "Participants whose time since diagnosis minus their answer to DIQ.060, insulin 
#   treatment period, was one year or less, meaning they started taking insulin within 
#   a year after diagnosis, were assigned as T1D. The rest were labeled as 
#   ‘possible-T2D’."

# We need to swap the yrs_using_insulin variable for diq060 since yrs_using_insulin is the
#   standardized time variable we created above. The new calculation will be:
#   diab_duration - yrs_using_insulin 
step_5 <- step_4 |> 
  mutate(
    step_5_var = case_when(
      (
        step_2_var == 'T2D' |
        step_3_var == 'T2D' |
        step_4_var == 'T2D' 
      ) ~ 'already classified / T2D',
      diab_duration - yrs_using_insulin <= 1 ~ 'T1D',
      .default = 'possible-T2D'
    )
  )

st5_dx <- sum(step_5$step_5_var == 'T1D')
st5_dx_pct <- round((st5_dx / nrow(step_5)) * 100, 2)

tabyl(step_5, step_5_var) |> 
  adorn_pct_formatting() |> 
#                step_5_var    n percent
#                       T1D  170    4.2% * identified in this step
#  already classified / T2D 3593   88.7%
#              possible-T2D  289    7.1%  * identified in this step via default value
  gt() |> 
  cols_label(
    step_5_var = 'Five-step diagnosis',
    n = 'Count', percent = 'Percent'
  ) |> 
  tab_header(
    title = md('**Step 5**: Results of Mosslemi five-step classification'),
    subtitle = subtitle
  ) |> 
  theme_gt_compact()
```

<mark>`r st5_dx` (`r st5_dx_pct`%) participants were identified as having Type I
diabetes during Step 5.</mark> 
`r sum(step_5$step_5_var == 'already classified / T2D')` participants have been previously
classified in Step 2, Step 3, or Step 4.
<mark>The remaining `r sum(step_5$step_5_var == 'possible-T2D')` participants did not meet
@mosslemi_2020 et al. strict criteria for either Type I or Type II diabetes and classified
as "possible Type II diabetes".</mark>

---

## Results

<!-- ![Figure 1: Results of Mosslemi et al. five-step diagnostic classification](misc/img/main_consort.png) -->


### Table 1: Classification with Five-step method

```{r}
#| label: table-1
#| message: false
#| warning: false
cohort <- the_data |> 
  left_join(step_5 |> select(seqn, diabetes_cat = step_5_var), by = 'seqn') |> 
  # filter(!is.na(diabetes_cat)) |> 
  mutate(
    yrs_using_insulin = did060,
    diabetes_cat = case_when(
      diabetes_cat == "already classified / T2D" ~ 'Type 2 DM',
      diabetes_cat == "T1D" ~ 'Type 1 DM',
      diabetes_cat == "possible-T2D" ~ 'Possible Type 2 DM',
      is.na(diabetes_cat) ~ 'No Diabetes',
      .default = ' ** error **'
    ),
    diabetes_cat = factor(
      diabetes_cat, levels = c('Type 1 DM', 'Possible Type 2 DM', 'Type 2 DM'),
      ordered = TRUE
    )
  )

cohort |> 
  tbl_summary(
    by = diabetes_cat,
    include = c(
      riagendr, ridageyr, ridreth1, dmdeduc2,
      did040, diab_duration,
      diq050, yrs_using_insulin, diq070
    ),
    label = c(
      yrs_using_insulin ~ 'Years using insulin'
    ),
    missing = 'no'
  ) |> 
  add_auto_labels() |> 
  extras() |> 
  modify_caption(
    caption = '<strong>Table 1</strong>: Participant characteristics and diabetes classification <br>
      using the 5-step process (Mosslemi et al., 2020)<br>
      <span style="font-size:10px">NHANES (2011-2022)</span><br>
      <i>{subtitle}</i>',
    text_interpret = 'html'
  )
```



### Table 2: Diabetes classification with adiposity measures

```{r}
#| label: table-2
#| warning: false
cohort |> 
  mutate(dxdtofat = dxdtofat/1000) |> 
  tbl_summary(
    by = diabetes_cat,
    include = c(
      dxdlapf, dxdrapf, dxdllpf, dxdrlpf,
      starts_with('dx'),  # includes dxd* & dxx*
      lbxgh:mean_dbp
    ),
    label = c(
      dxdtofat ~ 'Total Fat (kg)'
    ),
    missing = 'no'
  ) |> 
  add_auto_labels() |> 
  extras(overall = FALSE) |> 
  modify_caption(
    caption = '<strong>Table 2</strong>: Dual Energy X-ray Absorptiometry (DEXA)<br>
      results by five-step diabetes classification<br>
      <span style="font-size:10px">NHANES (2011-2022)</span><br>
      <i>{subtitle}</i>',
    text_interpret = 'html'
  )
```